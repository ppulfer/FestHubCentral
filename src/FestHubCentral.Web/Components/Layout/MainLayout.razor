@using FestHubCentral.Web.Services.Interfaces
@using FestHubCentral.Web.Data.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject ISettingsService SettingsService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inherits LayoutComponentBase

<CascadingAuthenticationState>
    <AuthorizeView>
        <Authorized>
            @if (brandingSettings != null)
            {
                <div class="page @(sidebarCollapsed ? "sidebar-collapsed" : "")" style="--brand-primary: @brandingSettings.PrimaryColor; --brand-secondary: @brandingSettings.SecondaryColor; --brand-accent: @brandingSettings.AccentColor;">
                    <div class="sidebar">
                        <NavMenu Settings="@brandingSettings" IsCollapsed="@sidebarCollapsed" OnToggleSidebar="@ToggleSidebar" />
                    </div>

                    <main>
                        <div class="top-row px-4 d-flex justify-content-end align-items-center">
                            <div class="user-menu">
                                <span class="user-name">@context.User.Identity?.Name</span>
                                <a href="/account/logout" class="btn btn-sm btn-outline-secondary">Logout</a>
                            </div>
                        </div>

                        <article class="content px-4">
                            @Body
                        </article>
                    </main>
                </div>
            }
            else
            {
                <div class="page">
                    <p>Loading...</p>
                </div>
            }
        </Authorized>
        <NotAuthorized>
            @Body
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private Data.Models.Settings? brandingSettings;
    private bool sidebarCollapsed = false;

    protected override async Task OnInitializedAsync()
    {
        brandingSettings = await SettingsService.GetSettingsAsync();
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
    }
}
