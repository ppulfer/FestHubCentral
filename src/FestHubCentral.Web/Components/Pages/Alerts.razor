@page "/alerts"
@using FestHubCentral.Web.Services.Interfaces
@using FestHubCentral.Web.Data.Models
@using FestHubCentral.Web.Components.Shared
@inject IAlertService AlertService
@rendermode InteractiveServer

<PageTitle>Alerts - FestHub Central</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>ðŸš¨ System Alerts</h1>
            <p class="text-muted">Monitor and resolve system notifications</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <StatCard Icon="ðŸš¨" Value="@unresolvedCount.ToString()" Label="Unresolved Alerts" CssClass="stat-card-danger" />
        </div>
        <div class="col-md-3">
            <StatCard Icon="âš ï¸" Value="@warningCount.ToString()" Label="Warnings" CssClass="stat-card-warning" />
        </div>
        <div class="col-md-3">
            <StatCard Icon="ðŸ”´" Value="@criticalCount.ToString()" Label="Critical" CssClass="stat-card-danger" />
        </div>
        <div class="col-md-3">
            <StatCard Icon="âœ…" Value="@resolvedCount.ToString()" Label="Resolved Today" CssClass="stat-card-success" />
        </div>
    </div>

    <div class="section-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-title mb-0">Active Alerts</h3>
            <div>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => filterResolved = false">
                    Active (@unresolvedAlerts.Count)
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => filterResolved = true">
                    Resolved (@resolvedAlerts.Count)
                </button>
            </div>
        </div>

        @if (displayedAlerts.Any())
        {
            @foreach (var alert in displayedAlerts)
            {
                <AlertCard Alert="@alert" OnResolve="ResolveAlert" />
            }
        }
        else
        {
            <p class="text-muted">No @(filterResolved ? "resolved" : "active") alerts</p>
        }
    </div>
</div>

@code {
    private List<Alert> allAlerts = new();
    private List<Alert> unresolvedAlerts = new();
    private List<Alert> resolvedAlerts = new();
    private List<Alert> displayedAlerts = new();
    private bool filterResolved = false;

    private int unresolvedCount = 0;
    private int warningCount = 0;
    private int criticalCount = 0;
    private int resolvedCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        allAlerts = (await AlertService.GetAllAlertsAsync()).ToList();
        unresolvedAlerts = allAlerts.Where(a => !a.IsResolved).ToList();
        resolvedAlerts = allAlerts.Where(a => a.IsResolved && a.ResolvedAt?.Date == DateTime.UtcNow.Date).ToList();

        displayedAlerts = filterResolved ? resolvedAlerts : unresolvedAlerts;

        unresolvedCount = unresolvedAlerts.Count;
        warningCount = unresolvedAlerts.Count(a => a.Severity == "Warning");
        criticalCount = unresolvedAlerts.Count(a => a.Severity == "Critical");
        resolvedCount = resolvedAlerts.Count;
    }

    private async Task ResolveAlert(int alertId)
    {
        await AlertService.ResolveAlertAsync(alertId, "User");
        await LoadAlerts();
    }
}
