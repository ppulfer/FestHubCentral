@page "/inventory/{productId:int}"
@using FestHubCentral.Web.Services.Interfaces
@using FestHubCentral.Web.Data.Models
@using FestHubCentral.Web.Data
@using FestHubCentral.Web.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject IProductService ProductService
@inject ISettingsService SettingsService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResources> Localizer
@rendermode InteractiveServer

<PageTitle>@(product?.Name ?? "Product") - Inventory Detail</PageTitle>

<div class="container-fluid">
    @if (product != null)
    {
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/inventory">Inventory</a></li>
                <li class="breadcrumb-item active">@product.Name</li>
            </ol>
        </nav>

        <div class="row mb-3">
            <div class="col">
                <h2>ðŸ“¦ @product.Name</h2>
            </div>
        </div>

        <div class="section-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="section-title mb-0">Pricing Information (@currentEventYear)</h3>
                <button class="btn btn-sm btn-outline-primary" @onclick="ShowPriceModal">
                    <i class="bi bi-pencil"></i> @(productEventPrice != null ? "Edit" : "Add") Prices
                </button>
            </div>
            @if (productEventPrice != null)
            {
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="pricing-card">
                            <div class="pricing-label">Purchase Price</div>
                            <div class="pricing-value">CHF @productEventPrice.PurchasePrice.ToString("F2")</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="pricing-card">
                            <div class="pricing-label">Selling Price</div>
                            <div class="pricing-value">CHF @productEventPrice.SellingPrice.ToString("F2")</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="pricing-card">
                            <div class="pricing-label">Profit Margin</div>
                            <div class="pricing-value profit">CHF @((productEventPrice.SellingPrice - productEventPrice.PurchasePrice).ToString("F2"))</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="pricing-card">
                            <div class="pricing-label">Special Price</div>
                            <div class="pricing-value @(productEventPrice.SpecialPrice.HasValue ? "text-info" : "text-muted")">
                                @(productEventPrice.SpecialPrice.HasValue ? $"CHF {productEventPrice.SpecialPrice.Value:F2}" : "-")
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mt-3">
                    No pricing information available for this product in @currentEventYear. Click "Add Prices" to set pricing.
                </div>
            }
        </div>

        <div class="section-card mb-4">
            <h3 class="section-title">Stock Available (@currentEventYear)</h3>
            @{
                var stagingLocations = productLocations.Where(pl => pl.Location.Category == "Staging Area").ToList();
            }
            @if (stagingLocations.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Storage Location</th>
                                <th class="text-end">Available Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var pl in stagingLocations)
                            {
                                var transferredTo = locationTransferAmounts.GetValueOrDefault(pl.LocationId).TransferredTo;
                                var transferredFrom = locationTransferAmounts.GetValueOrDefault(pl.LocationId).TransferredFrom;
                                var stock = transferredTo - transferredFrom;

                                <tr style="cursor: pointer;" @onclick="() => NavigateToLocation(pl.LocationId)">
                                    <td><strong>@pl.Location.Name</strong></td>
                                    <td class="text-end">
                                        <strong class="@(stock > 0 ? "text-success" : stock < 0 ? "text-danger" : "text-muted")">
                                            @stock @product.Unit
                                        </strong>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <p class="text-muted">No staging areas configured for this product in @currentEventYear</p>
                </div>
            }
        </div>

        <div class="section-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="section-title mb-0">Location Planning (@currentEventYear)</h3>
                <button class="btn btn-sm btn-outline-primary" @onclick="ShowAddLocationModal">
                    <i class="bi bi-plus-circle"></i> Add Location
                </button>
            </div>
            @if (productLocations.Any())
            {
                <div class="table-responsive mt-3">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Category</th>
                                <th class="text-end">Planned</th>
                                <th class="text-end">Initial Delivery</th>
                                <th class="text-end">Current Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var pl in productLocations.OrderBy(p => p.Location.Name))
                            {
                                var transferredTo = locationTransferAmounts.GetValueOrDefault(pl.LocationId).TransferredTo;
                                var transferredFrom = locationTransferAmounts.GetValueOrDefault(pl.LocationId).TransferredFrom;
                                var currentStock = transferredTo - transferredFrom;

                                <tr style="cursor: pointer;" @onclick="() => NavigateToLocation(pl.LocationId)">
                                    <td><strong>@pl.Location.Name</strong></td>
                                    <td>
                                        <span class="badge @(pl.Location.Category == "Staging Area" ? "bg-info" : "bg-secondary")">
                                            @pl.Location.Category
                                        </span>
                                    </td>
                                    <td class="text-end">@pl.PlannedAmount @product.Unit</td>
                                    <td class="text-end">@pl.InitialDelivery @product.Unit</td>
                                    <td class="text-end">
                                        <strong class="@(currentStock > 0 ? "text-success" : currentStock < 0 ? "text-danger" : "text-muted")">
                                            @currentStock @product.Unit
                                        </strong>
                                    </td>
                                    <td @onclick:stopPropagation="true" style="white-space: nowrap;">
                                        <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => ShowEditLocationModal(pl)" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProductLocation(pl)" title="Remove">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <p class="text-muted">No locations assigned for this product in @currentEventYear</p>
                </div>
            }
        </div>

        <div class="section-card">
            <h3 class="section-title">Recent Transfers (@currentEventYear)</h3>
            @if (recentTransfers.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Quantity</th>
                                <th>Created By</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var transfer in recentTransfers)
                            {
                                <tr>
                                    <td>@transfer.TransferDate.ToString("g")</td>
                                    <td>@(transfer.FromLocation?.Name ?? "N/A")</td>
                                    <td>@(transfer.ToLocation?.Name ?? "N/A")</td>
                                    <td><strong>@transfer.Amount @product.Unit</strong></td>
                                    <td>@(transfer.CreatedByUser?.UserName ?? "System")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <p class="text-muted">No transfers for this product in @currentEventYear</p>
                </div>
            }
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading product details...</p>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <h4>Product Not Found</h4>
            <p>The requested product could not be found.</p>
            <a href="/inventory" class="btn btn-primary">Back to Inventory</a>
        </div>
    }
</div>

@if (showPriceModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(productEventPrice != null ? "Edit" : "Add") Pricing for @currentEventYear</h5>
                    <button type="button" class="btn-close" @onclick="ClosePriceModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Purchase Price (CHF)</label>
                        <input type="number" step="0.01" min="0.01" class="form-control" @bind="editPurchasePrice" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Selling Price (CHF)</label>
                        <input type="number" step="0.01" min="0.01" class="form-control" @bind="editSellingPrice" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Special Price (CHF) - Optional</label>
                        <input type="number" step="0.01" min="0" class="form-control" @bind="editSpecialPrice" placeholder="Leave empty if not applicable" />
                    </div>
                    @if (editPurchasePrice > 0 && editSellingPrice > 0)
                    {
                        <div class="alert alert-info">
                            <strong>Profit Margin:</strong> CHF @((editSellingPrice - editPurchasePrice).ToString("F2"))
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePriceModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SavePrices" disabled="@(!CanSavePrices())">
                        Save Prices
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showLocationModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingProductLocationId > 0 ? "Edit" : "Add") Location Planning</h5>
                    <button type="button" class="btn-close" @onclick="CloseLocationModal"></button>
                </div>
                <div class="modal-body">
                    @if (editingProductLocationId == 0)
                    {
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <select class="form-select" @bind="selectedLocationId">
                                <option value="0">Select a location...</option>
                                @foreach (var loc in availableLocations)
                                {
                                    <option value="@loc.Id">@loc.Name (@loc.Category)</option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" value="@editingLocationName" disabled />
                        </div>
                    }
                    <div class="mb-3">
                        <label class="form-label">Planned Amount</label>
                        <input type="number" min="0" class="form-control" @bind="editPlannedAmount" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Delivery</label>
                        <input type="number" min="0" class="form-control" @bind="editInitialDelivery" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseLocationModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveProductLocation" disabled="@(!CanSaveLocation())">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .pricing-card {
        text-align: center;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f9fa;
    }

    .pricing-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 8px;
    }

    .pricing-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #212529;
    }

    .pricing-value.profit {
        color: #28a745;
    }
</style>

@code {
    [Parameter]
    public int ProductId { get; set; }

    private Product? product;
    private ProductEventPrice? productEventPrice;
    private List<ProductLocation> productLocations = new();
    private List<InventoryTransfer> recentTransfers = new();
    private Dictionary<int, (int TransferredTo, int TransferredFrom)> locationTransferAmounts = new();
    private int currentEventYear;
    private bool isLoading = true;

    private bool showPriceModal = false;
    private decimal editPurchasePrice = 0;
    private decimal editSellingPrice = 0;
    private decimal? editSpecialPrice = null;

    private bool showLocationModal = false;
    private int editingProductLocationId = 0;
    private string editingLocationName = string.Empty;
    private int selectedLocationId = 0;
    private int editPlannedAmount = 0;
    private int editInitialDelivery = 0;
    private List<Location> availableLocations = new();

    protected override async Task OnInitializedAsync()
    {
        var settings = await SettingsService.GetSettingsAsync();
        currentEventYear = settings?.CurrentEventYear ?? DateTime.UtcNow.Year;

        await LoadProductData();
        isLoading = false;
    }

    private async Task LoadProductData()
    {
        product = await DbContext.Products
            .Include(p => p.Supplier)
            .FirstOrDefaultAsync(p => p.Id == ProductId);

        if (product == null)
            return;

        productEventPrice = await DbContext.ProductEventPrices
            .FirstOrDefaultAsync(pep => pep.ProductId == ProductId && pep.EventYear == currentEventYear);

        productLocations = await DbContext.ProductLocations
            .Include(pl => pl.Location)
            .Where(pl => pl.ProductId == ProductId && pl.EventYear == currentEventYear)
            .ToListAsync();

        var transfers = await DbContext.InventoryTransfers
            .Include(it => it.FromLocation)
            .Include(it => it.ToLocation)
            .Include(it => it.CreatedByUser)
            .Where(it => it.ProductId == ProductId && it.EventYear == currentEventYear)
            .OrderByDescending(it => it.TransferDate)
            .ToListAsync();

        recentTransfers = transfers.Take(20).ToList();

        foreach (var location in productLocations)
        {
            var transferredTo = transfers
                .Where(t => t.ToLocationId == location.LocationId)
                .Sum(t => t.Amount);

            var transferredFrom = transfers
                .Where(t => t.FromLocationId == location.LocationId)
                .Sum(t => t.Amount);

            locationTransferAmounts[location.LocationId] = (transferredTo, transferredFrom);
        }
    }

    private void NavigateToLocation(int locationId)
    {
        Navigation.NavigateTo($"/locations/{locationId}");
    }

    private void ShowPriceModal()
    {
        if (productEventPrice != null)
        {
            editPurchasePrice = productEventPrice.PurchasePrice;
            editSellingPrice = productEventPrice.SellingPrice;
            editSpecialPrice = productEventPrice.SpecialPrice;
        }
        else
        {
            editPurchasePrice = 0;
            editSellingPrice = 0;
            editSpecialPrice = null;
        }
        showPriceModal = true;
    }

    private void ClosePriceModal()
    {
        showPriceModal = false;
    }

    private bool CanSavePrices()
    {
        return editPurchasePrice > 0 && editSellingPrice > 0;
    }

    private async Task SavePrices()
    {
        if (!CanSavePrices()) return;

        if (productEventPrice != null)
        {
            productEventPrice.PurchasePrice = editPurchasePrice;
            productEventPrice.SellingPrice = editSellingPrice;
            productEventPrice.SpecialPrice = editSpecialPrice > 0 ? editSpecialPrice : null;
            productEventPrice.UpdatedAt = DateTime.UtcNow;
            DbContext.ProductEventPrices.Update(productEventPrice);
        }
        else
        {
            productEventPrice = new ProductEventPrice
            {
                ProductId = ProductId,
                EventYear = currentEventYear,
                PurchasePrice = editPurchasePrice,
                SellingPrice = editSellingPrice,
                SpecialPrice = editSpecialPrice > 0 ? editSpecialPrice : null,
                CreatedAt = DateTime.UtcNow
            };
            DbContext.ProductEventPrices.Add(productEventPrice);
        }

        await DbContext.SaveChangesAsync();
        ClosePriceModal();
    }

    private async Task ShowAddLocationModal()
    {
        var assignedLocationIds = productLocations.Select(pl => pl.LocationId).ToHashSet();
        availableLocations = await DbContext.Locations
            .Where(l => !assignedLocationIds.Contains(l.Id))
            .OrderBy(l => l.Name)
            .ToListAsync();

        editingProductLocationId = 0;
        editingLocationName = string.Empty;
        selectedLocationId = 0;
        editPlannedAmount = 0;
        editInitialDelivery = 0;
        showLocationModal = true;
    }

    private void ShowEditLocationModal(ProductLocation pl)
    {
        editingProductLocationId = pl.Id;
        editingLocationName = pl.Location.Name;
        selectedLocationId = pl.LocationId;
        editPlannedAmount = pl.PlannedAmount;
        editInitialDelivery = pl.InitialDelivery;
        showLocationModal = true;
    }

    private void CloseLocationModal()
    {
        showLocationModal = false;
        editingProductLocationId = 0;
        editingLocationName = string.Empty;
        selectedLocationId = 0;
        editPlannedAmount = 0;
        editInitialDelivery = 0;
    }

    private bool CanSaveLocation()
    {
        if (editingProductLocationId > 0)
            return true;
        return selectedLocationId > 0;
    }

    private async Task SaveProductLocation()
    {
        if (!CanSaveLocation()) return;

        if (editingProductLocationId > 0)
        {
            var pl = await DbContext.ProductLocations.FindAsync(editingProductLocationId);
            if (pl != null)
            {
                pl.PlannedAmount = editPlannedAmount;
                pl.InitialDelivery = editInitialDelivery;
                pl.UpdatedAt = DateTime.UtcNow;
            }
        }
        else
        {
            var newPl = new ProductLocation
            {
                ProductId = ProductId,
                LocationId = selectedLocationId,
                EventYear = currentEventYear,
                PlannedAmount = editPlannedAmount,
                InitialDelivery = editInitialDelivery,
                CreatedAt = DateTime.UtcNow
            };
            DbContext.ProductLocations.Add(newPl);
        }

        await DbContext.SaveChangesAsync();
        await LoadProductData();
        CloseLocationModal();
    }

    private async Task DeleteProductLocation(ProductLocation pl)
    {
        DbContext.ProductLocations.Remove(pl);
        await DbContext.SaveChangesAsync();
        await LoadProductData();
    }
}
