@page "/"
@using FestHubCentral.Web.Services.Interfaces
@using FestHubCentral.Web.Components.Shared
@using FestHubCentral.Web.Data.Models
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Components.Authorization
@inject ILocationService LocationService
@inject ILocationTransferRequestService TransferRequestService
@inject ISettingsService SettingsService
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResources> Localizer
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>@Localizer["Nav.Dashboard"].Value - @(brandingSettings?.FestivalName ?? "FestHub Central") @(brandingSettings?.CurrentEventYear ?? DateTime.UtcNow.Year)</PageTitle>

<div class="container-fluid">
    @if (pendingTransferRequests.Any())
    {
        <div class="section-card mb-4">
            <h3 class="section-title">Pending Transfer Requests</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>From</th>
                            <th>Amount</th>
                            <th>Requested</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var request in pendingTransferRequests.Take(10))
                        {
                            <tr>
                                <td><strong>@request.Product.Name</strong></td>
                                <td>@request.FromLocation.Name</td>
                                <td>@request.Amount @request.Product.Unit</td>
                                <td>@request.RequestedAt.ToString("g")</td>
                                <td>
                                    <a href="/admin/transfer-requests" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Review
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (pendingTransferRequestCount > 10)
            {
                <div class="text-center mt-2">
                    <a href="/admin/transfer-requests" class="btn btn-outline-secondary btn-sm">
                        View all @pendingTransferRequestCount requests
                    </a>
                </div>
            }
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="section-card">
                <h2 class="section-title">@Localizer["Dashboard.FestivalGroundsMap"].Value</h2>
                <div class="vendor-grid">
                    @foreach (var location in locations.OrderBy(l => l.Name))
                    {
                        <div class="vendor-spot @GetSpotClass(location)" @onclick="() => NavigateToLocation(location?.Id)">
                            <div class="vendor-name">@location.Name</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private HubConnection? hubConnection;
    private Data.Models.Settings? brandingSettings;
    private List<Data.Models.Location> locations = new();
    private List<TransferRequest> pendingTransferRequests = new();
    private int pendingTransferRequestCount = 0;
    private readonly SemaphoreSlim _loadDataSemaphore = new(1, 1);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState?.User?.Identity?.IsAuthenticated == true)
        {
            var hasLocationRole = authState.User.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.Role)?.Value == "Location";
            if (hasLocationRole)
            {
                Navigation.NavigateTo("/location-dashboard", replace: true);
                return;
            }
        }

        brandingSettings = await SettingsService.GetSettingsAsync();
        await LoadData();
        await InitializeSignalR();
    }

    private async Task LoadData()
    {
        await _loadDataSemaphore.WaitAsync();
        try
        {
            var currentEventYear = brandingSettings?.CurrentEventYear ?? DateTime.UtcNow.Year;
            locations = (await LocationService.GetLocationsByEventYearAsync(currentEventYear)).ToList();
            pendingTransferRequests = (await TransferRequestService.GetPendingRequestsAsync()).ToList();
            pendingTransferRequestCount = pendingTransferRequests.Count;
        }
        finally
        {
            _loadDataSemaphore.Release();
        }
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/festivalhub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<int, decimal, string>("ReceiveNewOrder", async (orderId, amount, vendorName) =>
        {
            await LoadData();
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int, string, int>("ReceiveLowStockAlert", async (productId, productName, currentStock) =>
        {
            await LoadData();
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int, bool>("ReceiveLocationStatusUpdate", async (locationId, isOpen) =>
        {
            await LoadData();
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private string GetSpotClass(Data.Models.Location? location)
    {
        if (location == null) return "empty";
        return "occupied";
    }

    private void NavigateToLocation(int? locationId)
    {
        if (locationId.HasValue)
        {
            Navigation.NavigateTo($"/locations/{locationId}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
        _loadDataSemaphore.Dispose();
    }
}
