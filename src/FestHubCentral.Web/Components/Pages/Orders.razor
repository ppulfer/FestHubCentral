@page "/orders"
@using FestHubCentral.Web.Services.Interfaces
@using FestHubCentral.Web.Data.Models
@using FestHubCentral.Web.Components.Shared
@inject IOrderService OrderService
@inject ILocationService LocationService
@inject IInventoryService InventoryService
@rendermode InteractiveServer

<PageTitle>Orders - FestHub Central</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>ðŸ§¾ Order Management</h1>
            <p class="text-muted">Process sales and view order history</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowNewOrderForm">
                New Order
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <StatCard Icon="ðŸ’µ" Value="@todaysSales.ToString("C")" Label="Today's Sales" />
        </div>
        <div class="col-md-3">
            <StatCard Icon="ðŸ“" Value="@todaysOrderCount.ToString()" Label="Today's Orders" />
        </div>
        <div class="col-md-3">
            <StatCard Icon="ðŸ’³" Value="@cardSales.ToString("C")" Label="Card Sales" />
        </div>
        <div class="col-md-3">
            <StatCard Icon="ðŸ’°" Value="@cashSales.ToString("C")" Label="Cash Sales" />
        </div>
    </div>

    @if (showNewOrderForm)
    {
        <div class="section-card mb-4">
            <h3>Create New Order</h3>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Location</label>
                    <select class="form-select" @onchange="OnLocationSelected">
                        <option value="">Select Location</option>
                        @foreach (var location in locations)
                        {
                            <option value="@location.Id">@location.Name (Spot @location.LocationSpot)</option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" @bind="newOrder.PaymentMethod">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="FestivalToken">Festival Token</option>
                    </select>
                </div>
            </div>

            @if (selectedLocation != null)
            {
                <h4 class="mt-4">Add Items</h4>
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label">Product</label>
                        <select class="form-select" @bind="selectedProductId">
                            <option value="0">Select Product</option>
                            @* TODO: Need to refactor to query products separately since they're no longer tied to locations *@
                            @foreach (var product in availableProducts)
                            {
                                <option value="@product.Id">@product.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" @bind="quantity" min="1" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary w-100" @onclick="AddOrderItem">Add</button>
                    </div>
                </div>

                @if (newOrder.OrderItems.Any())
                {
                    <div class="table-responsive mb-3">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in newOrder.OrderItems)
                                {
                                    <tr>
                                        <td>@GetProductName(item.ProductId)</td>
                                        <td>@item.Quantity</td>
                                        <td>@item.UnitPrice.ToString("C")</td>
                                        <td>@item.Subtotal.ToString("C")</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveOrderItem(item)">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td colspan="2"><strong>@newOrder.TotalAmount.ToString("C")</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" @bind="newOrder.Notes" rows="2"></textarea>
                    </div>

                    <div>
                        <button class="btn btn-primary" @onclick="SubmitOrder">Submit Order</button>
                        <button class="btn btn-secondary" @onclick="CancelNewOrder">Cancel</button>
                    </div>
                }
            }
        </div>
    }

    <div class="section-card">
        <h3 class="section-title">Recent Orders</h3>

        <div class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Filter by Location</label>
                    <select class="form-select" @onchange="FilterByLocation">
                        <option value="">All Locations</option>
                        @foreach (var location in locations)
                        {
                            <option value="@location.Id">@location.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" @bind="filterStartDate" @bind:after="ApplyDateFilter" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" @bind="filterEndDate" @bind:after="ApplyDateFilter" />
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Date/Time</th>
                        <th>Location</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Payment</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in filteredOrders.Take(50))
                    {
                        <tr>
                            <td><strong>@order.OrderNumber</strong></td>
                            <td>@order.OrderDate.ToString("g")</td>
                            <td>@order.Location.Name</td>
                            <td>@order.OrderItems.Count items</td>
                            <td><strong>@order.TotalAmount.ToString("C")</strong></td>
                            <td><span class="badge bg-secondary">@order.PaymentMethod</span></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<Order> allOrders = new();
    private List<Order> filteredOrders = new();
    private List<Location> locations = new();
    private Location? selectedLocation;
    private List<Product> availableProducts = new();

    private Order newOrder = new();
    private bool showNewOrderForm = false;
    private int selectedProductId = 0;
    private int quantity = 1;

    private decimal todaysSales = 0;
    private int todaysOrderCount = 0;
    private decimal cardSales = 0;
    private decimal cashSales = 0;

    private DateTime filterStartDate = DateTime.UtcNow.Date;
    private DateTime filterEndDate = DateTime.UtcNow.Date;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        allOrders = (await OrderService.GetAllOrdersAsync()).ToList();
        filteredOrders = allOrders;
        locations = (await LocationService.GetAllLocationsAsync()).ToList();

        var today = DateTime.UtcNow.Date;
        todaysSales = await OrderService.GetTotalSalesByDateAsync(today);
        var todaysOrders = await OrderService.GetOrdersByDateRangeAsync(today, today.AddDays(1));
        todaysOrderCount = todaysOrders.Count();

        var paymentBreakdown = await OrderService.GetSalesByPaymentMethodAsync(today);
        cardSales = paymentBreakdown.GetValueOrDefault("Card", 0);
        cashSales = paymentBreakdown.GetValueOrDefault("Cash", 0);
    }

    private void ShowNewOrderForm()
    {
        newOrder = new Order
            {
                PaymentMethod = "Cash",
                OrderItems = new List<OrderItem>()
            };
        showNewOrderForm = true;
    }

    private void CancelNewOrder()
    {
        newOrder = new Order();
        selectedLocation = null;
        selectedProductId = 0;
        quantity = 1;
        showNewOrderForm = false;
    }

    private async Task OnLocationSelected(ChangeEventArgs e)
    {
        var locationIdStr = e.Value?.ToString();
        if (!string.IsNullOrEmpty(locationIdStr))
        {
            var locationId = int.Parse(locationIdStr);
            selectedLocation = await LocationService.GetLocationByIdAsync(locationId);
            newOrder.LocationId = locationId;
        }
    }

    private void AddOrderItem()
    {
        if (selectedProductId > 0 && quantity > 0 && selectedLocation != null)
        {
            var product = availableProducts.FirstOrDefault(p => p.Id == selectedProductId);
            if (product != null)
            {
                // TODO: Get price from ProductEventPrice for current event
                decimal unitPrice = 10.00m; // Temporary placeholder

                var orderItem = new OrderItem
                    {
                        ProductId = product.Id,
                        Quantity = quantity,
                        UnitPrice = unitPrice,
                        Subtotal = unitPrice * quantity
                    };

                newOrder.OrderItems.Add(orderItem);
                newOrder.TotalAmount = newOrder.OrderItems.Sum(oi => oi.Subtotal);

                selectedProductId = 0;
                quantity = 1;
            }
        }
    }

    private void RemoveOrderItem(OrderItem item)
    {
        newOrder.OrderItems.Remove(item);
        newOrder.TotalAmount = newOrder.OrderItems.Sum(oi => oi.Subtotal);
    }

    private async Task SubmitOrder()
    {
        if (newOrder.OrderItems.Any())
        {
            await OrderService.CreateOrderAsync(newOrder);
            await LoadData();
            CancelNewOrder();
        }
    }

    private string GetProductName(int productId)
    {
        return availableProducts.FirstOrDefault(p => p.Id == productId)?.Name ?? "Unknown";
    }

    private void FilterByLocation(ChangeEventArgs e)
    {
        var locationIdStr = e.Value?.ToString();
        if (string.IsNullOrEmpty(locationIdStr))
        {
            filteredOrders = allOrders;
        }
        else
        {
            var locationId = int.Parse(locationIdStr);
            filteredOrders = allOrders.Where(o => o.LocationId == locationId).ToList();
        }
    }

    private async Task ApplyDateFilter()
    {
        filteredOrders = (await OrderService.GetOrdersByDateRangeAsync(filterStartDate, filterEndDate.AddDays(1))).ToList();
    }
}
