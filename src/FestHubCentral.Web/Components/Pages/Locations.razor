@page "/locations"
@using FestHubCentral.Web.Services.Interfaces
@using FestHubCentral.Web.Data.Models
@using FestHubCentral.Web.Data
@using FestHubCentral.Web.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject ILocationService LocationService
@inject ISettingsService SettingsService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResources> Localizer
@rendermode InteractiveServer

<PageTitle>@Localizer["Nav.Vendors"].Value</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>üè™ @Localizer["Nav.Vendors"].Value (@currentEventYear)</h2>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowAddLocationForm">
                Add Location
            </button>
        </div>
    </div>

    <div class="section-card">
        <h3 class="section-title">Locations for @currentEventYear</h3>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>GPS</th>
                        <th>Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var location in GetPagedLocations())
                    {
                        <tr style="cursor: pointer;" @onclick="() => ViewLocation(location.Id)">
                            <td><strong>@location.Name</strong></td>
                            <td><span class="badge bg-info">@location.Category</span></td>
                            <td @onclick:stopPropagation="true">
                                @if (location.Latitude.HasValue && location.Longitude.HasValue)
                                {
                                    <a href="https://www.google.com/maps?q=@location.Latitude,@location.Longitude" target="_blank" class="btn btn-sm btn-outline-success" title="View Map">
                                        <i class="bi bi-geo-alt"></i>
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(location.ContactPerson))
                                {
                                    <div>@location.ContactPerson</div>
                                    <small class="text-muted">@location.ContactPhone</small>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td @onclick:stopPropagation="true" style="white-space: nowrap;">
                                <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => EditLocation(location)" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveLocation(location.Id)" title="Remove">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <Pagination CurrentPage="@currentPage"
                        TotalItems="@locations.Count"
                        PageSize="@pageSize"
                        OnPageChange="@HandlePageChange" />
        </div>
    </div>
</div>

@if (showAddModal)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Location to @currentEventYear</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddForm"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Choose an option:</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button"
                                    class="btn @(isCreatingNewLocation ? "btn-outline-primary" : "btn-primary")"
                                    @onclick="() => SetCreatingMode(false)">
                                Select Existing Location
                            </button>
                            <button type="button"
                                    class="btn @(isCreatingNewLocation ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="() => SetCreatingMode(true)">
                                Create New Location
                            </button>
                        </div>
                    </div>

                    @if (!isCreatingNewLocation)
                    {
                        <div class="mb-3">
                            <label class="form-label">Select Location</label>
                            <select class="form-select" @bind="selectedLocationId">
                                <option value="0">Select a location...</option>
                                @foreach (var location in availableLocations)
                                {
                                    <option value="@location.Id">@location.Name - @location.Category</option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label">Location Name</label>
                            <input type="text" class="form-control" @bind="newLocationName" placeholder="Enter location name" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" @bind="newLocationCategory">
                                <option value="Vendor">Vendor</option>
                                <option value="Staging Area">Staging Area</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Latitude (Optional)</label>
                                    <input type="number" step="0.000001" class="form-control" @bind="newLocationLatitude" placeholder="e.g., 47.3769" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Longitude (Optional)</label>
                                    <input type="number" step="0.000001" class="form-control" @bind="newLocationLongitude" placeholder="e.g., 8.5417" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Contact Person (Optional)</label>
                                    <input type="text" class="form-control" @bind="newLocationContactPerson" placeholder="Enter contact person" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Contact Phone (Optional)</label>
                                    <input type="text" class="form-control" @bind="newLocationContactPhone" placeholder="Enter phone" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Contact Email (Optional)</label>
                                    <input type="email" class="form-control" @bind="newLocationContactEmail" placeholder="Enter email" />
                                </div>
                            </div>
                        </div>
                    }

                    <div class="alert alert-info">
                        <small>Location will be added to the year: <strong>@currentEventYear</strong></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddForm">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="AddLocation" disabled="@(!CanAddLocation())">
                        Add Location
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showEditModal)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Location</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditForm"></button>
                </div>
                <div class="modal-body">
                    @if (editingLocation != null)
                    {
                        <div class="mb-3">
                            <label class="form-label">Location Name</label>
                            <input type="text" class="form-control" @bind="editingLocation.Name" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" @bind="editingLocation.Category">
                                <option value="Vendor">Vendor</option>
                                <option value="Staging Area">Staging Area</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Latitude</label>
                                    <input type="number" step="0.000001" class="form-control" @bind="editingLocation.Latitude" placeholder="e.g., 47.3769" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Longitude</label>
                                    <input type="number" step="0.000001" class="form-control" @bind="editingLocation.Longitude" placeholder="e.g., 8.5417" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" @bind="editingLocation.ContactPerson" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Contact Phone</label>
                                    <input type="text" class="form-control" @bind="editingLocation.ContactPhone" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Contact Email</label>
                                    <input type="email" class="form-control" @bind="editingLocation.ContactEmail" />
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditForm">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveLocation">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .modal {
        background-color: rgba(0, 0, 0, 0.5);
    }

    .table-actions {
        display: flex;
        gap: 0.5rem;
    }
</style>

@code {
    private List<Location> locations = new();
    private List<Location> availableLocations = new();
    private Location? editingLocation;
    private bool showAddModal = false;
    private bool showEditModal = false;

    private int currentEventYear = DateTime.UtcNow.Year;
    private int selectedLocationId = 0;
    private bool isCreatingNewLocation = false;

    private string newLocationName = string.Empty;
    private string newLocationCategory = "Vendor";
    private double? newLocationLatitude = null;
    private double? newLocationLongitude = null;
    private string newLocationContactPerson = string.Empty;
    private string newLocationContactPhone = string.Empty;
    private string newLocationContactEmail = string.Empty;

    private int currentPage = 1;
    private const int pageSize = 30;

    protected override async Task OnInitializedAsync()
    {
        var settings = await SettingsService.GetSettingsAsync();
        if (settings?.CurrentEventYear > 0)
        {
            currentEventYear = settings.CurrentEventYear;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        await LoadLocations();
        await LoadAvailableLocations();
    }

    private async Task LoadLocations()
    {
        locations = (await LocationService.GetLocationsByEventYearAsync(currentEventYear)).ToList();
        currentPage = 1;
    }

    private async Task LoadAvailableLocations()
    {
        var allLocations = await DbContext.Locations.OrderBy(l => l.Name).ToListAsync();
        var currentLocationIds = locations.Select(l => l.Id).ToHashSet();
        availableLocations = allLocations.Where(l => !currentLocationIds.Contains(l.Id)).ToList();
    }

    private void ShowAddLocationForm()
    {
        selectedLocationId = 0;
        isCreatingNewLocation = false;
        newLocationName = string.Empty;
        newLocationCategory = "Vendor";
        newLocationLatitude = null;
        newLocationLongitude = null;
        newLocationContactPerson = string.Empty;
        newLocationContactPhone = string.Empty;
        newLocationContactEmail = string.Empty;
        showAddModal = true;
    }

    private void SetCreatingMode(bool isCreating)
    {
        isCreatingNewLocation = isCreating;
        if (!isCreating)
        {
            selectedLocationId = 0;
        }
    }

    private bool CanAddLocation()
    {
        if (isCreatingNewLocation)
        {
            return !string.IsNullOrWhiteSpace(newLocationName);
        }
        else
        {
            return selectedLocationId > 0;
        }
    }

    private async Task AddLocation()
    {
        if (!CanAddLocation()) return;

        try
        {
            if (isCreatingNewLocation)
            {
                var newLocation = new Location
                {
                    Name = newLocationName.Trim(),
                    Category = newLocationCategory,
                    Latitude = newLocationLatitude,
                    Longitude = newLocationLongitude,
                    ContactPerson = string.IsNullOrWhiteSpace(newLocationContactPerson) ? null : newLocationContactPerson.Trim(),
                    ContactPhone = string.IsNullOrWhiteSpace(newLocationContactPhone) ? null : newLocationContactPhone.Trim(),
                    ContactEmail = string.IsNullOrWhiteSpace(newLocationContactEmail) ? null : newLocationContactEmail.Trim()
                };

                var createdLocation = await LocationService.CreateLocationAsync(newLocation);
                await LocationService.AddLocationToEventAsync(createdLocation.Id, currentEventYear);
            }
            else
            {
                await LocationService.AddLocationToEventAsync(selectedLocationId, currentEventYear);
            }

            await LoadData();
            CloseAddForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding location: {ex.Message}");
        }
    }

    private void EditLocation(Location location)
    {
        editingLocation = new Location
        {
            Id = location.Id,
            Name = location.Name,
            Category = location.Category,
            Latitude = location.Latitude,
            Longitude = location.Longitude,
            ContactPerson = location.ContactPerson,
            ContactPhone = location.ContactPhone,
            ContactEmail = location.ContactEmail
        };
        showEditModal = true;
    }

    private async Task SaveLocation()
    {
        if (editingLocation == null) return;

        try
        {
            await LocationService.UpdateLocationAsync(editingLocation);
            await LoadData();
            CloseEditForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving location: {ex.Message}");
        }
    }

    private async Task RemoveLocation(int locationId)
    {
        if (confirm("Are you sure you want to remove this location from the current event?"))
        {
            try
            {
                await LocationService.RemoveLocationFromEventAsync(locationId, currentEventYear);
                await LoadData();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error removing location: {ex.Message}");
            }
        }
    }

    private void ViewLocation(int locationId)
    {
        Navigation.NavigateTo($"/locations/{locationId}");
    }

    private void CloseAddForm()
    {
        showAddModal = false;
        selectedLocationId = 0;
        isCreatingNewLocation = false;
    }

    private void CloseEditForm()
    {
        showEditModal = false;
        editingLocation = null;
    }

    private bool confirm(string message)
    {
        return true;
    }

    private IEnumerable<Location> GetPagedLocations()
    {
        return locations
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize);
    }

    private async Task HandlePageChange(int newPage)
    {
        currentPage = newPage;
        await InvokeAsync(StateHasChanged);
    }
}
