@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using FestHubCentral.Web.Data.Models
@inject NavigationManager Navigation
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

            if (authState.User.Identity?.IsAuthenticated == true)
            {
                var user = await UserManager.GetUserAsync(authState.User);

                if (user?.RequiresPasswordChange == true)
                {
                    var currentUri = new Uri(Navigation.Uri);
                    var currentPath = currentUri.LocalPath;

                    if (currentPath != "/account/change-password" &&
                        currentPath != "/account/logout")
                    {
                        Navigation.NavigateTo("/account/change-password", forceLoad: true);
                    }
                }
            }
        }
    }
}
